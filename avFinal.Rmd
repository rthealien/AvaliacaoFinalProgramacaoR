---
title: "Avaliação Final de Introdução à Programação em R"
author: Giovanni Angelo dos Santos, Pedro Leonardo Motta Weyne Marques e Rafael Gomes de Oliveira
date: "07/11/2021"
output: 
  rmdformats::material
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE)
library(tidyverse)
library(rmarkdown)
library(plotly)
```

# Início

## Introdução

Esse documento é o resultado da avaliação final da matéria **Introdução à Programação em R**, ministrada pela professora Nadine, do curso de Especialização em Ciência de Dados na Fundação CEPERJ.

## Requisitos

Para a geração correta do Knit é necessária a instalação do pacote **rmdformats** através do comando

```{r requisitos, eval=FALSE}
install.packages("rmdformats")
```

## Dados

Serão utilizados os dados sobre as despesas cobertas pela cota para exercício da atividade parlamentar do deputados em 2020.

Abaixo temos os 10 primeiros registros para ter uma noção de como são os registros da tabela.

```{r dados,results='asis'}
dados <- read.csv2("Ano-2020.csv", encoding = "UTF-8")
dadosDeputados = dados %>% filter(!is.na(cpf))
dadosDeputados$data = as.Date(paste(dadosDeputados$numAno,dadosDeputados$numMes,"1",sep="-"))
paged_table(head(dadosDeputados, 10))
```

## Grupo

O grupo responsável por esse projeto é formado por:

-   Giovanni Angelo dos Santos
-   Pedro Leonardo Motta Weyne Marques
-   Rafael Gomes de Oliveira

# Análise

## Valor Gasto por Estado

```{r gasto_estado,message=FALSE, warning=FALSE, echo=FALSE}

options(scipen = 999)
gastos_estados = dadosDeputados %>%
  group_by(sgUF) %>%
  summarise(valor = sum(as.numeric(vlrLiquido), na.rm = TRUE)) %>%
  arrange(desc(valor))

#paged_table(gastos_estados)
knitr::kable(gastos_estados, caption = "Gastos por estado ordenados do maior para o menor valor")


gastos_estado_mes = dadosDeputados %>% 
                      group_by(data,sgUF) %>% 
                      #filter(sgPartido != "S.PART.") %>% 
                      summarise(valor = mean(as.numeric(vlrLiquido), na.rm = TRUE)) %>% 
                      arrange(desc(valor))

ggplotly( gastos_estado_mes %>% 
  ggplot() +
  geom_line(aes(x = data, y = valor, color = sgUF))+
  labs(title = "Média de Gastos Mensal por Estado em 2020"))

library(geobr)

dadosMapa <- structure(
  list(
    X = 1:27,
    uf = gastos_estados$sgUF,
    #valor = scales::rescale(gastos_estados$valor)
    valor = gastos_estados$valor
  ),
  class = "data.frame",
  row.names = c(NA, -27L)
)
states <- read_country(year = 2020, showProgress = FALSE)
states <-
  dplyr::left_join(states, dadosMapa, by = c("abbrev_state" = "uf"))
L = min(states$valor)
S = max(states$valor)

p = states %>% ggplot() +
  geom_sf(aes(fill =  valor, text= abbrev_state), size = 0.15, show.legend = TRUE) +
  scale_fill_gradient2(
    name = "Gasto por Estado",
    limits = c(L, S)
    ) 
    
  
    p = p +   labs(title = "Gasto por Estado") +
      theme(
        plot.caption = element_text(hjust = 0, face = "italic"),
        plot.title.position = "plot",
        plot.caption.position =  "plot"
      )
    
    p = p + theme(legend.position = "bottom") + theme(legend.title = element_text(size = 10),
                                                      legend.text = element_text(size = 10))

    ggplotly(p)
    
```

## Valor Gasto por Deputado

Análise para saber quais deputados tiveram mais gastos durante o ano.

```{r gasto_deputado,message=FALSE, warning=FALSE,echo=FALSE}
#Filtro
gastos_deputados = dadosDeputados %>%
  group_by(cpf, txNomeParlamentar) %>%
  summarise(valor = sum(as.numeric(vlrLiquido), na.rm = TRUE)) %>%
  arrange(desc(valor)) %>%
  select(txNomeParlamentar, valor)

gastos_deputados = head(gastos_deputados, 10)

knitr::kable(gastos_deputados,caption = "Os 10 deputados com maiores gastos")

fig = plot_ly(
  x = gastos_deputados$valor,
  y = gastos_deputados$txNomeParlamentar,
  name = "Gastos por Deputado",
  type = "bar",
  orientation = "h"
)

fig
```


## Valor Gasto por Partido {.tabset}
```{r echo=F, message=FALSE, warning=F}
gastos_partidos = dadosDeputados %>% 
                    group_by(sgPartido,txNomeParlamentar) %>% 
                      summarise(valor = sum(as.numeric(vlrLiquido), na.rm = TRUE)) %>% 
                    arrange(desc(valor))

gastos_partidos = head(gastos_partidos,100)

```

### Valor Total Gasto por Mês 

```{r echo=F, message=FALSE, warning=F}
options(scipen = 999)

gastos_mes_top10 = dadosDeputados %>% 
                    group_by(data) %>% 
                    summarise(valor = mean(as.numeric(vlrLiquido), na.rm = TRUE)) %>% 
                    arrange(desc(valor))
                    head(10)

ggplotly( gastos_mes_top10 %>% 
  ggplot() +
  geom_line(aes(x = data, y = valor))+
  labs(title = "Gasto Mensal em 2020"))
```

### Valor Médio Mensal Por Partido
```{r echo=F, message=FALSE, warning=F}
gastos_partido_mes = dadosDeputados %>% 
                      group_by(data,sgPartido) %>% 
                      filter(sgPartido != "S.PART.") %>% 
                      summarise(valor = mean(as.numeric(vlrLiquido), na.rm = TRUE)) %>% 
                      arrange(desc(valor)) #%>% 
                      #head(10)
                      
ggplotly( gastos_partido_mes %>% 
  ggplot() +
  geom_line(aes(x = data, y = valor, color = sgPartido))+
  labs(title = "Média de Gastos Mensal por Partido em 2020"))

```

### Gasto relativo a quantidade de deputados

```{r}
gastos_partidos = dadosDeputados %>%
  group_by(sgPartido) %>%
  summarise(
    valor = sum(as.numeric(vlrLiquido), na.rm = TRUE),
    valor_por_qtd_deputado = sum(as.numeric(vlrLiquido), na.rm = TRUE) /
      n_distinct(cpf)
  ) %>%
  arrange(desc(valor_por_qtd_deputado))

#paged_table(gastos_partidos)
knitr::kable(gastos_partidos)
```

## Valor Gasto com Empresas Estrangeiras
```{r}
gastos_estrangeiro = dadosDeputados %>%
  filter(txtCNPJCPF=="000.000.000/0001-0") %>% 
  group_by(txtCNPJCPF) %>%
  summarise(valor = sum(as.numeric(vlrLiquido), na.rm = TRUE))
knitr::kable(gastos_estrangeiro)
```
## Valor Gasto por Mês
```{r}
gastos_mes = dadosDeputados %>%
  group_by(datEmissao = format(as.Date(datEmissao), "%Y-%m")) %>%
  summarise(valor = sum(as.numeric(vlrLiquido), na.rm = TRUE))
knitr::kable(gastos_mes)
```

# Conclusão

Depois da análise dos dados concluimos que...